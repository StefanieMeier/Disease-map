<!DOCTYPE html>
<html lang="en">
<head>
    <title>Disease mapping</title>

    <script src="static/libraries/d3.v4.min.js" charset="utf-8"></script>
    <script src="static/libraries/topojson.v1.min.js"></script>
    <script src="static/libraries/d3-queue.v2.min.js"></script>
    <script src="static/libraries/textures.js" charset="utf-8"></script>
    <script src="static/libraries/simpleheat.js"></script> 
    <script src="static/libraries/d3-hsv.v0.1.min.js"></script>
    <script src="static/libraries/d3-contour.v1.min.js"></script>
 	<script src="static/libraries/Chart.min.js"></script>
 	<script src="static/libraries/Chart.bundle.min.js"></script>

	<link rel = "stylesheet" type ="text/css" href="static/css/style_diseasemap.css" />

</head>

<body>

    <div id='container'></div>

    <div id="title">Incidence rate of vector-borne diseases in changing climates</div>

    <div id="loadingContainer" class="blinking" style="z-index: 1">Loading data...</div>

    <div id="legendContainer">

	    <div class="styled-select semi-square">
	    	<!-- The <select> element is used to create a drop-down list. -->
	    	<select id="dropDown">
		        <!-- The <option> tags inside the <select> element define the available options in the list. -->
		        <option value="Dengue">Dengue</option>
		        <option value="Malaria">Malaria</option>
		        <option value="Tick_enc">Tick borne encephalitis</option>
	    	</select>
	    </div>

	    <div id="sliderContainer">
	        <input id="timeslide" type="range" min="0" max="9" value="0" step="1" class="slider"/><br>
	        <!-- The <span> tag provides a way to add a hook to a part of a text or a part of a document. -->
	        <span id="range">2008</span>
	    </div>

	    <div id="tempContainer">
	    	<div id="tempTitle">Average temperature January</div>
		    <div id="tempGradient"></div>
		    <div id="tempText">-22.8 14.5</div>
		</div>

	    <div id="incidenceTitle">Incidence rate (N/100000)
	    	</div>


		<div id="incidenceContainer1">
	    	<div id="incidencePattern1"></div>
			<div id="incidenceText1">0</div>
		</div>
	 	<div id="incidenceContainer2">
	    	<div id="incidencePattern2"></div>
			<div id="incidenceText2">No data</div>
		</div>
		<div id="incidenceContainer3">
	    	<div id="incidencePattern3"></div>
			<div id="incidenceText3">No data</div>
		</div>    	
		<div id="incidenceContainer4">
	    	<div id="incidencePattern4"></div>
			<div id="incidenceText4">No data</div>
		</div>
		<div id="incidenceContainer5">
	    	<div id="incidencePattern5"></div>
			<div id="incidenceText5">No data</div>
		</div>

	</div>
    <div id="selectContainer" style="z-index: 1">Click on a country to plot the details</div>
	<div id="plotContainer" style="position: relative; height:400px; width:600px">
	    <canvas id="myChart" width="500px" height="400px"></canvas>
	</div>
	

    <div id="text">Background<br>
		<p>Changing climates can influence the geographic distribution of insects that transmit diseases such as dengue (main vector: <i>Aedes</i> mosquitos), malaria (<i>Anopheles</i> mosquitos), or tick-borne encephalitis (TBE, <i>Ixodes</i> ticks). While ticks that  transmit TBE are endemic in Eastern Europe, mosquitos of the genera <i>Aedes</i> (especially the vectors of the dengue virus <i>Aedes aegypti</i> and <i>Aedes albopictus</i>) and <i>Anopheles</i> have been observed occationally in some areas in Southern Europe where they are known as invasive species[1].  Whether the disease vectors can spread to new areas depends on multiple factors, including temperature, rainfall, and humidity. Studies showed for example that milder conditions enable ticks and mosquitos to overwinter [2, 3, 4]. For this reason, I focused on the distribution of the abovementioned diseases in Europe in connection with the average January temperature between 2008 and 2017, so as to see whether a trend is observable.</p><br>
		Approach
		<p>The disease data has been downloaded from the <a href="https://atlas.ecdc.europa.eu/public/index.aspx">European Centre for Disease Prevention and Control (ecdc)</a>. Not for all countries data was available at all times. 
		The temperature data has been downloaded from the  <a href="https://cds.climate.copernicus.eu/cdsapp#!/home">Climate Data Store</a>. The temperatures represent the average January temperature 2 m above ground. The simpleheat.js library was used to map the temperatures. For some areas (e.g. in Turkey or waters) no data was available. These areas appear black on the map. The textrures.js library was used to create the patterns.</p>
		<br>
		Results and conclusions
		<p>No clear trend between rising temperatures and rising disease incidence rates is observable. There are multiple possible explanations for this finding. 
		<ul>
		<li>It should be considered that the reported notification rates strongly depend on the quality of the public health surveillance. Not all disease incidences might be reported in every country at all times. This can make it difficult to compare incidence rates between countries and over time.</li> 	
		<li>It is important to notice that the majority of malaria and dengue cases in Europe are currently imported by international travelers and immigrants. Local transmission has only been observed occasionally in certain countries in southern Europe. Thus, it is not surprising that temperature and incidence rate do not seem to correlate.</li> 	
		<li>The map only shows the data of one decade (all that was available from the European Centre for Disease Prevention). It is possible that a trend could be detected when comparing data over a longer time frame.</li>
        <li>Multiple other factors apart from temperature, such as humidity or the availability of breeding sites, influence how well insects can spread. For simplicity reasons, they were not (yet) included in this model.</li>  
		</ul>	
		It will be of interest to analyze more data in the future. According to current projections the temperatures in Europe will continue to rise and certain mosquitos such as Aedes or Anopheles will become endemic and ticks more abundant. It is likely that there will be an increase in cases of diseases transmitted by these insects locally.</p>
		<p style="font-size:80%;">
        [1] <a href="https://atlas.ecdc.europa.eu/public/index.aspx">European Centre for Disease Prevention and Control (ecdc)</a><br>
		[2]<a href="https://doi.org/10.1098/rsif.2012.0138">Caminade C., et al. 2012 Suitability of European climate for the Asian tiger mosquito Aedes albopictus: recent trends and future scenarios <i>J R Soc Interface</i></a><br>
		[3] <a href="https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(00)05250-8/fulltext">Lindgren E., Gustafson R., 2001 Tick-borne encephalitis in Sweden and climate change <i>The Lancet</i></a><br>
		[4] <a href="https://www.sciencedirect.com/science/article/pii/S1198743X16301203">Piperaki E., Daikos L., 2016 Malaria in Europe: emerging threat or minor nuisance? <i>Clin Microbiol Infect</i></a></p>
	</div>

	<script>
		// define the dimensions of the canvas that d3 uses
        var width = 700, height = 700; center = [12, 72];

        // define the years for the dropdown and set an initial value
        var inputValue = "2008";
        var syear = ["2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017"];

        // define the global variables that will contain the loaded data
        var disease_data_loaded = null;
        var temp_data_loaded = null
        var avg_temp_data_loaded = null
        var countries_data_loaded = null;
        var temp_max = null;
        var temp_min = null;

        // define the array of country names to be used
        countries_names = ["Aland","Albania","Andorra","Armenia","Austria","Azerbaijan","Belarus","Belgium","Bosnia and Herz.","Bulgaria","Croatia","Cyprus","Czech Rep.","Denmark","Estonia","Faeroe Is.","Finland","France","Georgia","Germany","Greece","Greenland","Guernsey","Hungary","Iceland","Ireland","Isle of Man","Italy","Jersey","Kazakhstan","Kosovo","Latvia","Liechtenstein","Lithuania","Luxembourg","Macedonia","Moldova","Monaco","Montenegro","N. Cyprus","Netherlands","Norway","Poland","Portugal","Romania","Russia","San Marino","Serbia","Slovakia","Slovenia","Spain","Sweden","Switzerland","Turkey","Turkmenistan","Ukraine","United Kingdom","Vatican"]

        // use the Mercator projection to generate the map
        var projection = d3.geoMercator().scale(600).translate([width / 2, 0]).center(center);

        // generate a d3 path that uses the projection
        var path = d3.geoPath().projection(projection);

        // select the main div that contains the canvas and svg map
        var div = d3.select('#container');
        var canvasLayer = div.append('canvas').attr('id', 'heatmap').attr('width', width).attr('height', height);

        // the getContext() method returns an object that provides methods and properties for drawing on the canvas. 
        var canvas = canvasLayer.node(),
            context = canvas.getContext("2d");

        // append the svg with the previously defined dimensions
        var svg = div.append('svg').attr('id', 'map').attr('width', width).attr('height', height);

        // changes map if time slider is used; "this" will refer to the parent object in the body of the function; + use numerical value (if string)
        d3.select("#timeslide").on("input", function () {
            update(+this.value);
        });

        // changes map with new disease rendering when disease dopdown is changed
        d3.select("#dropDown").on("change", function(){
            update_disease(d3.select("#dropDown").node().value);
        });

        // append a tooltip div and the offset from the mouse that will be used to display the country name
        var tooltip = d3.select("#container").append("div").attr("class", "tooltip hidden");
    	var offsetL = document.getElementById('container').offsetLeft+50;
    	var offsetT = document.getElementById('container').offsetTop+50;

        // update map according to year selected
        function update(value) {
            document.getElementById("range").innerHTML = syear[value];
            inputValue = syear[value];
            plot_heat(canvas, temp_data_loaded, projection, +syear[value]);
            plot_disease(countries_data_loaded,disease_data_loaded,svg,d3.select("#dropDown").node().value,syear[value]);
        }

        // update map according to disease selected
        function update_disease(disease_value) {
            plot_heat(canvas, temp_data_loaded, projection, +inputValue);
            plot_disease(countries_data_loaded, disease_data_loaded, svg, disease_value, +inputValue);
        }

        // load data: ready function runs when all data done loading
        d3.queue()
            .defer(d3.json, "static/data/eu.topojson") // Load EU Countries
            .defer(d3.json, "/getdiseasedata") // Load disease data
            .defer(d3.json, "/gettempdata") // Load temperature data
            .defer(d3.json, "/getavgtempdata") // Load average temperature data
            .await(ready); // Run 'ready' when all JSONs are loaded

        //plot heat map for temperature distribution
        var plot_heat = function (can,t_meas,proj,year) {

            // use simpleheat library to plot the heat map
            var heat = simpleheat(can);

            // define function for scaling the heat map for max and min temperatures
            var scale_val = function (val) {
                if (val != 0) {
                    return (val - temp_min) / (temp_max - temp_min)
                } 
                else {
                    return null
                }
            }

            // arrow function (=>) expression is an alternative to a regular function expression
            // The map() method creates a new array with the results of calling a provided function on every element in the calling array.
            // The data() method attaches data to, or gets data from, selected elements.
            // convert from lon/lat to x/y in canvas; temperature in input year -> heat map
            heat.data(t_meas.map(d => { return [proj([d.lon, d.lat])[0], proj([d.lon, d.lat])[1], scale_val(+d[year])] }));
            
            // set point radius and blur radius for heat map (25 and 15 by default)
            heat.radius(5, 15);

            // set maximum for domain
            heat.max(1.0);
            heat.resize();

            // draw into canvas, with minimum opacity threshold
            heat.draw(0.10);
        }


        // draw the legend for the disease incidence rates by creating 5 boxes with corresponding textures
        function plot_disease_legend(){
    		
            // append svgs to all 5 div boxes
            var svg1 = d3.select("#incidencePattern1").append("svg");
            var svg2 = d3.select("#incidencePattern2").append("svg");
            var svg3 = d3.select("#incidencePattern3").append("svg");
            var svg4 = d3.select("#incidencePattern4").append("svg");
            var svg5 = d3.select("#incidencePattern5").append("svg");

            // for every box that needs a texture, add the circle texture with increasing radii
            var t2 = textures.circles()
                .size(27)
                .radius(0.25)                    
                .strokeWidth(2)
                .stroke("red")
                .complement();
            svg2.call(t2);
            svg2.append("rect")
            	.attr("width", 36)
            	.attr("height", 36)
            	.style("fill", t2.url());

            var t3 = textures.circles()
                .size(13)
                .radius(0.25)                    
                .strokeWidth(2)
                .stroke("red")
                .complement();
            svg3.call(t3);
            svg3.append("rect")
            	.attr("width", 36)
            	.attr("height", 36)
            	.style("fill", t3.url());

            var t4 = textures.circles()
                .size(8)
                .radius(0.25)                    
                .strokeWidth(2)
                .stroke("red")
                .complement();
            svg4.call(t4);
            svg4.append("rect")
            	.attr("width", 36)
            	.attr("height", 36)
            	.style("fill", t4.url());

            var t5 = textures.lines()
                .size(5)
                .strokeWidth(0.4)
                .stroke("white")
            svg5.call(t5);
            svg5.append("rect")
            	.attr("width", 36)
            	.attr("height", 36)
            	.style("fill", t5.url());
        }

        // overlay the disease textures for every country
        var plot_disease = function(data,disease_data,svg,disease_name,year){

            //find the maximum occurance from the diseases
            var maxval_disease = d3.max(disease_data, d => +d[disease_name]);

            // remove all previous textures
            svg.selectAll("*").remove();

            //scale the max disease incidence rate for the texture radii
            var scale_val_disease = function (val) {
                if (val != 0) {
                    return (val) / (maxval_disease)
                } 
                else {
                    return null
                }
            }

            // define an empty object to write the right textures into for every country
            var tById = {};

            // function defining the texture/pattern of each country depending on the disease and year selected
            countries_names.forEach(function (d) { 

                // find the right data for every country and year
                var found_row = disease_data.filter(e => e["country"] == d && e["year"] == year)

                // then add a texture pattern for  that country
                if (found_row[0] && found_row[0][disease_name]!=null) {

                    	tById[d] = textures //texture representing incidence rate
                        .circles()
                        .size(9 / (0.05+scale_val_disease(+found_row[0][disease_name])))
                        .radius(0.25)                    
                        .strokeWidth(2)
                        .stroke("red")
                        .complement();
                } 
                // texture for countries with no available disease data
                else {
                    tById[d] = textures 
                        .lines()
                        .size(5)
                        .strokeWidth(0.4)
                        .stroke("white")
                }

            });

            // default textures will be circles
            const texture = textures
                .circles()

            // call the country specific textures to the svg
            countries_names.forEach(function (d) {
                svg.call(tById[d]);
            });

            // draw all countries
            svg.append("g")
                .selectAll('.country')
                //draw the country map from the imported topojson file
                .data(topojson.feature(data, data.objects.europe).features) // Bind TopoJSON data elements
                .enter().append("path")
                .attr('class', 'country')
                .attr('d', path)
                // draw the specific plot when clicking on a country
                .on('click', drawchart)
                //show the tooltip when hovering
                .on("mousemove", function(d){
                	showTooltip(d.properties.name,year,disease_data,disease_name)
                })
          		.on("mouseout",  function(d,i) {
              		tooltip.classed("hidden", true);
           		})
                // append the country specific textures to the svg
                .style("fill", texture.url())
                .style("fill", function(d) {
                    return tById[d.properties.name].url() // get rate value for property matching data ID
                    //pass rate value to color function, return color based on domain and range
                })
                .style("stroke", "white");

            // add the legend text to the disease legend
            d3.select("#incidenceText2").text((maxval_disease/3).toFixed(2))
			d3.select("#incidenceText3").text((2*maxval_disease/3).toFixed(2))
            d3.select("#incidenceText4").text(maxval_disease.toFixed(2))
        }

        // display the tooltip with the country name and the disease incident rate
        function showTooltip(c_name,d_year,disease_data,disease_name) {
            // find the right data for the specified country and year
        	var found_row = disease_data.filter(e => e["country"] == c_name && e["year"] == d_year)
        	
            // when no data available just say that
            var label = c_name+": no data";

            // otherwise print the incidence rate next to the country name
        	if (found_row[0] && found_row[0][disease_name]!=null) {
        		label = c_name+": "+parseFloat(found_row[0][disease_name]).toFixed(2);
        	}

            // get the mouse location
          	var mouse = d3.mouse(svg.node())
            	.map( function(d) { return parseInt(d); } );

            // show the tooltip at the offset mouse location
          	tooltip.classed("hidden", false)
            	.attr("style", "left:"+(mouse[0]+offsetL)+"px;top:"+(mouse[1]+offsetT)+"px")
            	.html(label);
        }

        //function is called when all data is loaded
        function ready(error, data, disease_data,temp_measurements,avg_temps) {
            if (error) throw error;

            // hide the container that displays the "loading.." text
            d3.select('#loadingContainer').style("display", "none") 

            // write the loaded data to the global variables so that it is available in the other functions as well
            countries_data_loaded = data;
            disease_data_loaded = disease_data;
            temp_data_loaded = temp_measurements;
            avg_temp_data_loaded = avg_temps;

            // determine the min and max temperature values and write them to the globally defines variables so that they are available in the other functions as well
            var global_min = 1000;
            var global_max = -2000;
            syear.forEach(function (y) {
                minval = d3.min(temp_measurements, d => +d[+y]);
                maxval = d3.max(temp_data_loaded, d => +d[+y]);
                global_max = Math.max(maxval, global_max);
                global_min = Math.min(minval, global_min);
            });
            temp_max = global_max;
            temp_min = global_min;

            // plot the map, legends and heat map
            plot_disease(data, disease_data, svg, "Dengue", 2008);

            plot_disease_legend();
           
            plot_heat(canvas,temp_measurements,projection,2008);

        }


		// draw disease/temperature vs time plot when a country is selected
        function drawchart(d) {

            //hide the container that shows the text to select a country
            d3.select('#selectContainer').style("display", "none") 

            // redraw the chart every time
        	document.getElementById('myChart').remove();

            // append a new chart with the right dimensions
  			d3.select('#plotContainer').append('canvas').attr('id', 'myChart').attr('width','600px').attr('height','400px');


	        var ctx = document.getElementById('myChart');

            //destroy the chart if it still exists
	        if(dhtChart){
	        	dhtChart.destroy();
	        } 

            // define the font style
	        Chart.defaults.global.defaultFontColor = 'black';
	        Chart.defaults.global.defaultFontFamily = 'Helvetica';

            // create the chart with the years as x axis labels and the specific average temperatures and all three diseases
			var dhtChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [2008,2009,2010,2011,2012,2013,2014,2015,2016,2017],
                    datasets: [
                        {
                            label: "Temperature",
                            borderColor: "rgba(247, 161, 1, 1)",
                            fillColor: "rgba(247, 161, 1, 1)",
                            strokeColor: "rgba(247, 161, 1, 1)",
                            backgroundColor: 'transparent',
                            yAxisID: 'y-axis-1',
                            data: Object.values(avg_temp_data_loaded.filter(e => e["country"] == d.properties.name)[0])
                        },
                        {
                            label: "Dengue",
                            borderColor: "midnightblue",
                            fillColor: "midnightblue",
                            strokeColor: "midnightblue",
                            backgroundColor: 'transparent',
                            yAxisID: 'y-axis-2',
                            data: disease_data_loaded.filter(e => e["country"] == d.properties.name).map(x => x.Dengue)
                        },
                        {
                            label: "Malaria",
                            borderColor: "rgba(14, 151, 45, 1)",
                            fillColor: "rgba(14, 151, 45,1)",
                            strokeColor: "rgba(14, 151, 45,1)",
                            backgroundColor: 'transparent',
                            yAxisID: 'y-axis-2',
                            data: disease_data_loaded.filter(e => e["country"] == d.properties.name).map(x => x.Malaria)
                        },
                        {
                            label: "Tick-borne encephalitis",
                            borderColor: "rgba(0, 167, 216, 1)",
                            fillColor: "rgba(0, 167, 216, 1)",
                            strokeColor: "rgba(0, 167, 216, 1)",
                            backgroundColor: 'transparent',
                            yAxisID: 'y-axis-2',
                            data: disease_data_loaded.filter(e => e["country"] == d.properties.name).map(x => x.Tick_enc)
                        }
                    ]
                },
                    //show two y-axes for temperature and incidence rate
                    options: {
                    	title: {
            	            display: true,
            	            text: d.properties.name,
            	            fontSize: 15,
            	            fontStyle: "normal",

            	        },
                        scales: {
                            yAxes: [{
                            	scaleLabel: {
                        	        display: true,
                        	        labelString: 'Temperature (°C)'
                        	    },
                                id: 'y-axis-1',                             
                                type: 'linear',
                                position: 'left',
                            }, {
                            	scaleLabel: {
                        	        display: true,
                        	        labelString: 'Incidence Rate (N/100k)'
                        	    },
                                id: 'y-axis-2',                             
                                type: 'linear',
                                position: 'right',
                            }]
                        }   
                    }
            });

        }

        
	</script>	
</body>
</html>